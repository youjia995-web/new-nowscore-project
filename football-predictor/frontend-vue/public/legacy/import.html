<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>数据导入 · 霍金AI 足球预测智能体项目</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="./styles.css" rel="stylesheet">
</head>
<body>
  <div class="container py-4">
    <h1 class="mb-4">数据导入</h1>
    <p class="text-muted mb-4">下载模板，填写球队每日指标并上传入库；支持队名映射与阵容导入。</p>

    <div class="card mb-4">
      <div class="card-header"><h3>模板下载</h3></div>
      <div class="card-body d-flex gap-3">
        <button class="btn btn-outline-primary" id="dl-csv">下载CSV模板（紧凑）</button>
        <button class="btn btn-outline-primary" id="dl-xlsx">下载Excel模板（紧凑）</button>
        <div id="dl-status" class="small text-muted"></div>
      </div>
    </div>

    <div class="card mb-4">
      <div class="card-header"><h3>球队指标导入</h3></div>
      <div class="card-body">
        <div class="row g-2 align-items-center">
          <div class="col-md-6">
            <input type="file" class="form-control" id="metrics-file" accept=".csv,.xlsx,.xls" />
          </div>
          <div class="col-md-3">
            <button class="btn btn-success" id="btn-import-metrics">上传并导入</button>
          </div>
          <div class="col-md-3">
            <div id="import-result" class="small text-muted"></div>
          </div>
        </div>
        <p class="small text-muted mt-2">表头支持紧凑与标准两种；导入时自动映射并默认填充当天日期。</p>
      </div>
    </div>

    <div class="card mb-4">
      <div class="card-header"><h3>队名映射导入</h3></div>
      <div class="card-body">
        <div class="row g-2 align-items-center">
          <div class="col-md-6">
            <input type="file" class="form-control" id="alias-file" accept=".csv,.xlsx,.xls" />
          </div>
          <div class="col-md-3">
            <button class="btn btn-outline-success" id="btn-import-aliases">上传并导入队名映射</button>
          </div>
          <div class="col-md-3">
            <div id="import-aliases-result" class="small text-muted"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="card mb-4">
      <div class="card-header"><h3>阵容导入</h3></div>
      <div class="card-body">
        <div class="row g-2 align-items-center">
          <div class="col-md-6">
            <input type="file" class="form-control" id="roster-file" accept=".csv,.xlsx,.xls" />
          </div>
          <div class="col-md-2">
            <input type="text" class="form-control" id="roster-team" placeholder="球队（可选）" />
          </div>
          <div class="col-md-2">
            <input type="text" class="form-control" id="roster-season" placeholder="赛季（可选）" />
          </div>
          <div class="col-md-2">
            <button class="btn btn-outline-primary" id="btn-import-roster">上传并导入阵容</button>
          </div>
        </div>
        <div id="import-roster-result" class="small text-muted mt-2"></div>
      </div>
    </div>

    <div class="card mb-4">
      <div class="card-header"><h3>交易所快照上传</h3></div>
      <div class="card-body">
        <div class="row g-2 align-items-center">
          <div class="col-md-5">
            <input type="file" class="form-control" id="exchange-file" accept=".xlsx,.xls" />
          </div>
          <div class="col-md-2">
            <input type="text" class="form-control" id="exchange-home" placeholder="主队" />
          </div>
          <div class="col-md-2">
            <input type="text" class="form-control" id="exchange-away" placeholder="客队" />
          </div>
          <div class="col-md-2">
            <input type="text" class="form-control" id="exchange-sheet" placeholder="工作表(可选)" />
          </div>
          <div class="col-md-1">
            <button class="btn btn-outline-success" id="btn-upload-exchange">上传</button>
          </div>
        </div>
        <div id="exchange-upload-status" class="small text-muted mt-2"></div>
        <div id="exchange-summary-box" class="mt-2" style="display:none;">
          <strong>融合摘要：</strong> <span id="exchange-summary-text"></span>
        </div>
      </div>
    </div>

    <div class="text-end">
      <a href="/" class="btn btn-outline-secondary">返回平台首页</a>
    </div>
  </div>

  <script>
    let __API_BASE_CACHE = null;
    async function getApiBase() {
      if (__API_BASE_CACHE !== null) return __API_BASE_CACHE;
      const override = new URLSearchParams(window.location.search).get('api');
      if (override) { __API_BASE_CACHE = override; return override; }
      const host = window.location.hostname, proto = window.location.protocol;
      const candidates = [
        '', `${proto}//${host}:3309`, `${proto}//127.0.0.1:3309`,
        `${proto}//${host}:5518`, `${proto}//127.0.0.1:5518`
      ];
      for (const base of candidates) {
        try {
          const resp = await fetch(base + '/api/companies');
          if (resp.ok) { __API_BASE_CACHE = base; return base; }
        } catch(_) {}
      }
      __API_BASE_CACHE = '';
      return '';
    }

    async function downloadTemplate(format) {
      const status = document.getElementById('dl-status');
      try {
        const base = await getApiBase();
        const url = base + '/api/admin/team-metrics/template?format=' + format + '&style=compact';
        const resp = await fetch(url);
        if (!resp.ok) throw new Error('模板下载失败');
        const blob = await resp.blob();
        const fname = format === 'xlsx' ? 'team_metrics_template_compact.xlsx' : 'team_metrics_template_compact.csv';
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = fname;
        a.click();
        status.textContent = '已下载模板：' + fname;
      } catch (e) {
        status.textContent = '下载失败：' + (e && e.message ? e.message : e);
      }
    }

    document.getElementById('dl-csv').addEventListener('click', () => downloadTemplate('csv'));
    document.getElementById('dl-xlsx').addEventListener('click', () => downloadTemplate('xlsx'));

    document.getElementById('btn-import-metrics').addEventListener('click', async () => {
      const resultEl = document.getElementById('import-result');
      try {
        const inp = document.getElementById('metrics-file');
        if (!inp.files || !inp.files[0]) { alert('请选择要上传的文件'); return; }
        const base = await getApiBase();
        const fd = new FormData();
        fd.append('file', inp.files[0]);
        const resp = await fetch(base + '/api/admin/team-metrics/import', { method: 'POST', body: fd });
        if (!resp.ok) throw new Error('导入接口调用失败');
        const data = await resp.json();
        const ok = Number(data.imported || 0);
        const overwritten = Number(data.overwritten || 0);
        const errs = Array.isArray(data.errors) ? data.errors : [];
        resultEl.innerHTML = `导入成功 ${ok} 条。${overwritten ? '覆盖删除 ' + overwritten + ' 条旧数据。' : ''}${errs.length ? '有错误行：' + errs.length : ''}`;
      } catch (e) {
        console.error('导入失败', e);
        alert('导入过程中发生错误，请检查文件格式与必填字段。');
      }
    });

    document.getElementById('btn-import-aliases').addEventListener('click', async () => {
      const resultEl = document.getElementById('import-aliases-result');
      try {
        const inp = document.getElementById('alias-file');
        if (!inp.files || !inp.files[0]) { alert('请选择要上传的映射文件'); return; }
        const base = await getApiBase();
        const fd = new FormData();
        fd.append('file', inp.files[0]);
        const resp = await fetch(base + '/api/admin/team-aliases/import', { method: 'POST', body: fd });
        if (!resp.ok) throw new Error('映射导入接口调用失败');
        const data = await resp.json();
        const ok = Number(data.imported || 0);
        resultEl.textContent = '映射导入成功 ' + ok + ' 条。';
      } catch (e) {
        console.error('映射导入失败', e);
        alert('映射导入过程中发生错误，请检查文件列名与格式。');
      }
    });

    document.getElementById('btn-import-roster').addEventListener('click', async () => {
      const resultEl = document.getElementById('import-roster-result');
      try {
        const inp = document.getElementById('roster-file');
        if (!inp.files || !inp.files[0]) { alert('请选择要上传的阵容文件'); return; }
        const team = (document.getElementById('roster-team').value || '').trim();
        const season = (document.getElementById('roster-season').value || '').trim();
        const base = await getApiBase();
        const fd = new FormData();
        fd.append('file', inp.files[0]);
        const params = new URLSearchParams();
        if (team) params.append('team', team);
        if (season) params.append('season', season);
        const resp = await fetch(base + '/api/admin/roster/import' + (params.toString() ? ('?' + params.toString()) : ''), { method: 'POST', body: fd });
        if (!resp.ok) throw new Error('阵容导入接口调用失败');
        const data = await resp.json();
        const stats = data.stats || {};
        resultEl.textContent = `导入完成：新增 ${Number(stats.inserted||0)} 条，更新 ${Number(stats.updated||0)} 条，跳过 ${Number(stats.skipped||0)} 条。`;
      } catch (e) {
        console.error('阵容导入失败', e);
        alert('导入阵容过程中发生错误，请检查文件格式与必填列（球员/球队/赛季）。');
      }
    });

    document.getElementById('btn-upload-exchange').addEventListener('click', async () => {
      const statusEl = document.getElementById('exchange-upload-status');
      const box = document.getElementById('exchange-summary-box');
      const text = document.getElementById('exchange-summary-text');
      try {
        const inp = document.getElementById('exchange-file');
        if (!inp.files || !inp.files[0]) { alert('请选择 Excel 文件'); return; }
        const home = (document.getElementById('exchange-home').value || '').trim();
        const away = (document.getElementById('exchange-away').value || '').trim();
        const sheet = (document.getElementById('exchange-sheet').value || '').trim();
        const base = await getApiBase();
        const fd = new FormData();
        fd.append('file', inp.files[0]);
        const params = new URLSearchParams();
        if (home) params.append('home', home);
        if (away) params.append('away', away);
        if (sheet) params.append('sheet', sheet);
        const resp = await fetch(base + '/api/admin/exchange-snapshot/upload' + (params.toString() ? ('?' + params.toString()) : ''), { method: 'POST', body: fd });
        if (!resp.ok) throw new Error('上传失败');
        const data = await resp.json();
        statusEl.textContent = '已上传，事件键：' + (data.event_key || '');
        const s = (data.features && data.features.summary) ? String(data.features.summary) : '';
        if (s) {
          text.textContent = s;
          box.style.display = '';
        } else {
          box.style.display = 'none';
        }
      } catch (e) {
        console.error('上传失败', e);
        alert('上传过程中发生错误，请检查文件格式与工作表选择。');
      }
    });
  </script>
</body>
</html>