<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>自动填充测试</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        button { margin: 5px; padding: 8px 15px; cursor: pointer; }
        input { margin: 5px; padding: 5px; }
        .result { margin-top: 10px; padding: 10px; background: #f5f5f5; border-radius: 3px; }
    </style>
</head>
<body>
    <h1>Vue自动填充功能测试</h1>
    
    <div class="test-section">
        <h3>测试1: 直接API调用</h3>
        <button onclick="testDirectAPI()">测试Napoli API</button>
        <div id="api-result" class="result"></div>
    </div>
    
    <div class="test-section">
        <h3>测试2: 模拟Vue自动填充流程</h3>
        <input type="text" id="team-name" placeholder="输入球队名称" value="Napoli">
        <button onclick="simulateAutoFill()">模拟自动填充</button>
        <div id="autofill-result" class="result"></div>
    </div>
    
    <div class="test-section">
        <h3>测试3: 完整数据验证</h3>
        <button onclick="validateCompleteData()">验证完整数据</button>
        <div id="validation-result" class="result"></div>
    </div>

    <script>
        // 测试直接API调用
        async function testDirectAPI() {
            const resultDiv = document.getElementById('api-result');
            try {
                const response = await fetch('http://localhost:8000/api/teams/metrics?team=Napoli');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                resultDiv.innerHTML = `<span class="success">✓ API调用成功</span><br>数据: <pre>${JSON.stringify(data, null, 2)}</pre>`;
                return data;
            } catch (error) {
                resultDiv.innerHTML = `<span class="error">✗ API调用失败: ${error.message}</span>`;
                throw error;
            }
        }
        
        // 模拟Vue自动填充流程
        async function simulateAutoFill() {
            const teamName = document.getElementById('team-name').value.trim();
            const resultDiv = document.getElementById('autofill-result');
            
            if (!teamName) {
                resultDiv.innerHTML = `<span class="error">请输入球队名称</span>`;
                return;
            }
            
            try {
                resultDiv.innerHTML = `<span class="info">正在获取 ${teamName} 的数据...</span>`;
                
                // 模拟API调用
                const response = await fetch(`http://localhost:8000/api/teams/metrics?team=${encodeURIComponent(teamName)}`);
                if (!response.ok) {
                    if (response.status === 404) {
                        resultDiv.innerHTML = `<span class="error">未找到 ${teamName} 的数据</span>`;
                        return;
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const metrics = await response.json();
                resultDiv.innerHTML = `<span class="success">✓ 成功获取 ${teamName} 的数据</span><br>数据: <pre>${JSON.stringify(metrics, null, 2)}</pre>`;
                
                // 模拟数据填充验证
                validateDataMapping(metrics, resultDiv);
                
            } catch (error) {
                resultDiv.innerHTML = `<span class="error">✗ 自动填充失败: ${error.message}</span>`;
            }
        }
        
        // 验证数据映射
        function validateDataMapping(metrics, resultDiv) {
            const requiredFields = ['games_played', 'xg', 'xga', 'xpts', 'goals_for', 'goals_against', 'wins', 'draws', 'losses', 'points'];
            const optionalFields = ['npxg', 'npxga', 'ppda', 'dc'];
            
            let html = '<br><span class="info">数据字段验证:</span><br>';
            
            // 验证必需字段
            requiredFields.forEach(field => {
                if (metrics.hasOwnProperty(field) && metrics[field] !== undefined && metrics[field] !== null) {
                    html += `<span class="success">✓ ${field}: ${metrics[field]}</span><br>`;
                } else {
                    html += `<span class="error">✗ ${field}: 缺失或无效</span><br>`;
                }
            });
            
            // 验证可选字段
            optionalFields.forEach(field => {
                if (metrics.hasOwnProperty(field) && metrics[field] !== undefined && metrics[field] !== null) {
                    html += `<span class="success">✓ ${field}: ${metrics[field]}</span><br>`;
                } else {
                    html += `<span class="info">○ ${field}: 可选字段缺失</span><br>`;
                }
            });
            
            resultDiv.innerHTML += html;
        }
        
        // 验证完整数据结构
        async function validateCompleteData() {
            const resultDiv = document.getElementById('validation-result');
            
            try {
                resultDiv.innerHTML = `<span class="info">正在验证完整数据结构...</span>`;
                
                // 获取Napoli数据
                const response = await fetch('http://localhost:8000/api/teams/metrics?team=Napoli');
                const data = await response.json();
                
                let html = '<span class="success">✓ 数据获取成功</span><br>';
                
                // 验证数据类型
                const validations = [
                    { field: 'team', type: 'string', expected: 'Napoli' },
                    { field: 'games_played', type: 'number', min: 0 },
                    { field: 'xg', type: 'number', min: 0 },
                    { field: 'xga', type: 'number', min: 0 },
                    { field: 'xpts', type: 'number', min: 0 },
                    { field: 'goals_for', type: 'number', min: 0 },
                    { field: 'goals_against', type: 'number', min: 0 },
                    { field: 'wins', type: 'number', min: 0 },
                    { field: 'draws', type: 'number', min: 0 },
                    { field: 'losses', type: 'number', min: 0 },
                    { field: 'points', type: 'number', min: 0 }
                ];
                
                validations.forEach(({ field, type, min, expected }) => {
                    if (data.hasOwnProperty(field)) {
                        const value = data[field];
                        if (typeof value === type) {
                            if (min !== undefined && value < min) {
                                html += `<span class="error">✗ ${field}: 值 ${value} 小于最小值 ${min}</span><br>`;
                            } else if (expected !== undefined && value !== expected) {
                                html += `<span class="error">✗ ${field}: 期望值 ${expected}, 实际值 ${value}</span><br>`;
                            } else {
                                html += `<span class="success">✓ ${field}: ${value}</span><br>`;
                            }
                        } else {
                            html += `<span class="error">✗ ${field}: 类型错误, 期望 ${type}, 实际 ${typeof value}</span><br>`;
                        }
                    } else {
                        html += `<span class="error">✗ ${field}: 字段缺失</span><br>`;
                    }
                });
                
                html += `<br><span class="success">✓ 所有验证完成！数据可用于自动填充。</span>`;
                resultDiv.innerHTML = html;
                
            } catch (error) {
                resultDiv.innerHTML = `<span class="error">✗ 验证失败: ${error.message}</span>`;
            }
        }
        
        // 页面加载完成后自动运行基础测试
        window.addEventListener('load', async () => {
            console.log('测试页面加载完成');
            try {
                await testDirectAPI();
                console.log('基础API测试完成');
            } catch (error) {
                console.error('基础测试失败:', error);
            }
        });
    </script>
</body>
</html>